name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"

      - name: Run tests
        run: go test ./... -v

      - name: Build executables
        run: |
          $VERSION = "${{ github.ref_name }}"
          $COMMIT = "${{ github.sha }}"
          $BUILD_DATE = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $LDFLAGS = "-X github.com/smitstech/AzureAutoHibernate/internal/version.Version=$VERSION -X github.com/smitstech/AzureAutoHibernate/internal/version.GitCommit=$COMMIT -X github.com/smitstech/AzureAutoHibernate/internal/version.BuildDate=$BUILD_DATE"
          go build -ldflags="$LDFLAGS" -o AzureAutoHibernate.exe ./cmd/autohibernate
          go build -ldflags="-H=windowsgui $LDFLAGS" -o AzureAutoHibernate.Notifier.exe ./cmd/notifier
          go build -ldflags="$LDFLAGS" -o AzureAutoHibernate.Updater.exe ./cmd/updater

      - name: Package binaries
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item AzureAutoHibernate.exe dist/
          Copy-Item AzureAutoHibernate.Notifier.exe dist/
          Copy-Item AzureAutoHibernate.Updater.exe dist/
          Copy-Item config.json dist/
          Compress-Archive -Path dist\* -DestinationPath AzureAutoHibernate-${{ github.ref_name }}-windows-amd64.zip

      - name: Extract release notes from CHANGELOG
        run: |
          $changelog = Get-Content CHANGELOG.md -Raw
          $version = "${{ github.ref_name }}"
          # Remove 'v' prefix if present for matching
          $versionNumber = $version -replace '^v', ''

          # Try to extract the specific version section
          $pattern = "(?s)## \[$versionNumber\][^\n]*\s*(.*?)\s*(?=---\s*##|\z)"
          if ($changelog -match $pattern) {
            $releaseNotes = $matches[1].Trim()
            if ($releaseNotes -ne "" -and $releaseNotes -ne "- (nothing yet)") {
              # Add header
              $releaseNotes = "## What's Changed`n`n" + $releaseNotes
              $releaseNotes | Out-File -FilePath release-notes.md -Encoding utf8
              Write-Host "Release notes extracted successfully for $version"
              Write-Host "---"
              Write-Host $releaseNotes
              Write-Host "---"
            } else {
              "No changes documented for this release." | Out-File -FilePath release-notes.md -Encoding utf8
            }
          } else {
            Write-Host "Warning: Could not find version $versionNumber in CHANGELOG.md"
            "Release $version" | Out-File -FilePath release-notes.md -Encoding utf8
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: AzureAutoHibernate-${{ github.ref_name }}-windows-amd64.zip
          body_path: release-notes.md
